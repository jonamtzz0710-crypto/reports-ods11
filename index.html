<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ciudadano - ODS 11</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            background: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        .app {
            max-width: 450px;
            margin: auto;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
        }

        .screen {
            display: none;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .active { display: block; }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #007bff;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 8px;
        }

        button:hover { background: #0056b3; }

        .menu {
            display: flex;
            justify-content: space-around;
            background: #eaeaea;
            padding: 10px 0;
            border-top: 1px solid #ccc;
        }

        #map, #map-lista {
            height: 250px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .report {
            background: #f0fff0;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .img-preview {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
        }

    </style>
</head>
<body>

<div class="app">

    <header>Reporte Ciudadano - ODS 11</header>

    <!-- Inicio -->
    <div id="inicio" class="screen active">
        <h2>Bienvenido</h2>
        <p>App para reportar problemas en tu comunidad (baches, basura, etc.).</p>
        <button onclick="cambiarPantalla('nuevo')">Crear reporte</button>
        <button onclick="cambiarPantalla('lista')">Ver reportes</button>
    </div>

    <!-- Crear reporte -->
    <div id="nuevo" class="screen">
        <h2>Nuevo Reporte</h2>

        <label>Tipo:</label>
        <select id="tipo">
            <option value="Baches">Baches</option>
            <option value="Basura">Basura</option>
            <option value="Vandalismo">Vandalismo</option>
            <option value="Iluminación">Iluminación</option>
            <option value="Otro">Otro</option>
        </select>

        <label>Descripción:</label>
        <textarea id="descripcion" rows="3"></textarea>

        <label>Subir imagen:</label>
        <input type="file" id="foto" accept="image/*">
        <img id="preview-img" class="img-preview" style="display:none;">

        <label>Seleccionar ubicación:</label>
        <div id="map"></div>

        <button onclick="guardarReporte()">Guardar</button>
    </div>

    <!-- Lista de reportes -->
    <div id="lista" class="screen">
        <h2>Reportes Guardados</h2>
        <div id="map-lista"></div>
        <div id="contenedor-reportes"></div>
    </div>

    <!-- Menú inferior -->
    <div class="menu">
        <button onclick="cambiarPantalla('inicio')">Inicio</button>
        <button onclick="cambiarPantalla('nuevo')">Nuevo</button>
        <button onclick="cambiarPantalla('lista')">Reportes</button>
    </div>

</div>

<script>

    /* =======================
       CAMBIAR PANTALLAS
       =======================*/
    function cambiarPantalla(id) {
        document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");

        if (id === "nuevo") inicializarMapaNuevo();
        if (id === "lista") initMapaLista();
    }

    /* =======================
       VISTA PREVIA IMAGEN
       =======================*/
    document.getElementById("foto").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const img = document.getElementById("preview-img");
            img.src = e.target.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(file);
    });

    /* =======================
       MAPA PARA CREAR REPORTE
       =======================*/
    let lat = null, lng = null;
    let mapNuevo = null;
    let markerNuevo = null;

    function inicializarMapaNuevo() {
        setTimeout(() => {
            if (!mapNuevo) {
                mapNuevo = L.map("map").setView([19.4326, -99.1332], 13);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 19
                }).addTo(mapNuevo);

                mapNuevo.on("click", (e) => {
                    lat = e.latlng.lat;
                    lng = e.latlng.lng;

                    if (markerNuevo) markerNuevo.remove();
                    markerNuevo = L.marker([lat, lng]).addTo(mapNuevo);
                });
            }

            mapNuevo.invalidateSize();
        }, 300);
    }

    /* =======================
       GUARDAR REPORTE
       =======================*/
    function guardarReporte() {
        const tipo = document.getElementById("tipo").value;
        const descripcion = document.getElementById("descripcion").value;
        const foto = document.getElementById("preview-img").src;

        if (!descripcion.trim() || lat === null || lng === null) {
            alert("Completa todo y selecciona un punto en el mapa.");
            return;
        }

        const reporte = {
            tipo,
            descripcion,
            foto,
            lat,
            lng,
            fecha: new Date().toLocaleString()
        };

        let lista = JSON.parse(localStorage.getItem("reportes")) || [];
        lista.push(reporte);
        localStorage.setItem("reportes", JSON.stringify(lista));

        alert("Reporte guardado ✔️");

        document.getElementById("descripcion").value = "";
        document.getElementById("preview-img").style.display = "none";
        lat = lng = null;

        cambiarPantalla("lista");
        mostrarReportes();
    }

    /* =======================
       MOSTRAR REPORTES LISTA
       =======================*/
    function mostrarReportes() {
        const cont = document.getElementById("contenedor-reportes");
        cont.innerHTML = "";

        const lista = JSON.parse(localStorage.getItem("reportes")) || [];

        lista.forEach((r, i) => {
            const div = document.createElement("div");
            div.className = "report";

            div.innerHTML = `
                <strong>${r.tipo}</strong><br>
                <small>${r.fecha}</small><br>
                <p>${r.descripcion}</p>
                ${r.foto ? `<img src="${r.foto}" class="img-preview">` : ""}
                <p><strong>Ubicación:</strong> ${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}</p>
                <button style="background:#d9534f" onclick="eliminarReporte(${i})">Eliminar</button>
            `;

            cont.appendChild(div);
        });
    }

    /* =======================
       MAPA CON TODOS LOS REPORTES
       =======================*/
    let mapLista = null;

    function initMapaLista() {
        setTimeout(() => {
            const lista = JSON.parse(localStorage.getItem("reportes")) || [];

            if (!mapLista) {
                mapLista = L.map("map-lista").setView([19.4326, -99.1332], 12);

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 19
                }).addTo(mapLista);
            }

            mapLista.eachLayer(layer => {
                if (layer instanceof L.Marker) mapLista.removeLayer(layer);
            });

            lista.forEach(r => {
                L.marker([r.lat, r.lng])
                    .addTo(mapLista)
                    .bindPopup(`<strong>${r.tipo}</strong><br>${r.descripcion}`);
            });

            mapLista.invalidateSize();
        }, 300);
    }

    /* =======================
       ELIMINAR REPORTE
       =======================*/
    function eliminarReporte(i) {
        let lista = JSON.parse(localStorage.getItem("reportes")) || [];
        lista.splice(i, 1);
        localStorage.setItem("reportes", JSON.stringify(lista));
        mostrarReportes();
        initMapaLista();
    }

    mostrarReportes();
</script>

</body>
</html>

