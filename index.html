<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Ciudadano - ODS 11</title>

    <!-- Leaflet (mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            background: #f4f4f4;
            font-family: Arial, sans-serif;
        }

        /* Pantalla tipo app */
        .app {
            max-width: 450px;
            margin: auto;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 20px;
        }

        .screen {
            display: none;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .active { display: block; }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #007bff;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 8px;
        }

        button:hover { background: #0056b3; }

        .menu {
            display: flex;
            justify-content: space-around;
            background: #eaeaea;
            padding: 10px 0;
            border-top: 1px solid #ccc;
        }

        .menu button {
            width: auto;
            padding: 10px 20px;
            background: #007bff;
        }

        .report {
            background: #f0fff0;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .img-preview {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 10px;
        }

        #map {
            height: 250px;
            border-radius: 10px;
            margin-top: 10px;
        }

    </style>
</head>
<body>

<div class="app">

    <header>Reporte Ciudadano - ODS 11</header>

    <!-- Pantalla Inicio -->
    <div id="inicio" class="screen active">
        <h2>Bienvenido</h2>
        <p>Esta app permite reportar problemas en tu comunidad como basura, baches, vandalismo, etc.</p>
        <button onclick="cambiarPantalla('nuevo')">Crear reporte</button>
        <button onclick="cambiarPantalla('lista')">Ver reportes</button>
    </div>

    <!-- Crear reporte -->
    <div id="nuevo" class="screen">
        <h2>Nuevo Reporte</h2>

        <label>Tipo de problema:</label>
        <select id="tipo">
            <option value="Baches">Baches</option>
            <option value="Basura">Basura</option>
            <option value="Vandalismo">Vandalismo</option>
            <option value="Iluminación">Iluminación</option>
            <option value="Otro">Otro</option>
        </select>

        <label>Descripción:</label>
        <textarea id="descripcion" rows="3"></textarea>

        <label>Subir imagen:</label>
        <input type="file" id="foto" accept="image/*">

        <img id="preview-img" class="img-preview" style="display:none;">

        <label>Ubicación en el mapa:</label>
        <div id="map"></div>

        <button onclick="guardarReporte()">Guardar Reporte</button>
    </div>

    <!-- Lista de reportes -->
    <div id="lista" class="screen">
        <h2>Reportes Guardados</h2>
        <div id="contenedor-reportes"></div>
    </div>

    <!-- Menú -->
    <div class="menu">
        <button onclick="cambiarPantalla('inicio')">Inicio</button>
        <button onclick="cambiarPantalla('nuevo')">Nuevo</button>
        <button onclick="cambiarPantalla('lista')">Reportes</button>
    </div>

</div>

<script>
    // Cambiar pantallas
    function cambiarPantalla(id) {
        document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
    }

    // Previsualización de imagen
    document.getElementById("foto").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            const img = document.getElementById("preview-img");
            img.src = e.target.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(file);
    });

    // Mapa Interactivo
    let lat = 0, lng = 0;
    const map = L.map('map').setView([19.4326, -99.1332], 13);
    let marker;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    map.on("click", function (e) {
        lat = e.latlng.lat;
        lng = e.latlng.lng;

        if (marker) marker.remove();
        marker = L.marker([lat, lng]).addTo(map);
    });

    // Guardar reporte
    function guardarReporte() {
        const tipo = document.getElementById("tipo").value;
        const descripcion = document.getElementById("descripcion").value;
        const foto = document.getElementById("preview-img").src;

        if (descripcion.trim() === "" || !lat || !lng) {
            alert("Completa todos los campos y selecciona el mapa.");
            return;
        }

        const reporte = {
            tipo,
            descripcion,
            foto,
            lat,
            lng,
            fecha: new Date().toLocaleString()
        };

        let lista = JSON.parse(localStorage.getItem("reportes")) || [];
        lista.push(reporte);
        localStorage.setItem("reportes", JSON.stringify(lista));

        alert("Reporte guardado ✔️");
        cambiarPantalla("lista");
        mostrarReportes();
    }

    // Mostrar reportes guardados
    function mostrarReportes() {
        const cont = document.getElementById("contenedor-reportes");
        cont.innerHTML = "";

        const lista = JSON.parse(localStorage.getItem("reportes")) || [];

        lista.forEach((r, i) => {
            const div = document.createElement("div");
            div.className = "report";

            div.innerHTML = `
                <strong>${r.tipo}</strong><br>
                <small>${r.fecha}</small><br>
                <p>${r.descripcion}</p>
                ${r.foto ? `<img src="${r.foto}" class="img-preview">` : ""}
                <p><strong>Ubicación:</strong> ${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}</p>
                <button onclick="eliminarReporte(${i})" style="background:#d9534f">Eliminar</button>
            `;

            cont.appendChild(div);
        });
    }

    // Eliminar reporte
    function eliminarReporte(i) {
        let lista = JSON.parse(localStorage.getItem("reportes")) || [];
        lista.splice(i, 1);
        localStorage.setItem("reportes", JSON.stringify(lista));
        mostrarReportes();
    }

    mostrarReportes();
</script>

</body>
</html>
